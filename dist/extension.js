"use strict";var ke=Object.create;var N=Object.defineProperty;var Te=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames;var Ae=Object.getPrototypeOf,Le=Object.prototype.hasOwnProperty;var Re=(o,e,t)=>e in o?N(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var d=(o,e)=>N(o,"name",{value:e,configurable:!0});var Oe=(o,e)=>{for(var t in e)N(o,t,{get:e[t],enumerable:!0})},me=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of $e(e))!Le.call(o,n)&&n!==t&&N(o,n,{get:()=>e[n],enumerable:!(r=Te(e,n))||r.enumerable});return o};var y=(o,e,t)=>(t=o!=null?ke(Ae(o)):{},me(e||!o||!o.__esModule?N(t,"default",{value:o,enumerable:!0}):t,o)),Ue=o=>me(N({},"__esModule",{value:!0}),o);var C=(o,e,t)=>Re(o,typeof e!="symbol"?e+"":e,t);var Qe={};Oe(Qe,{activate:()=>Ve,deactivate:()=>Ye,getExtensionState:()=>qe,getLogger:()=>_e,isExtensionInitialized:()=>Ze});module.exports=Ue(Qe);var U=y(require("vscode"));var g=y(require("vscode"));var H=y(require("vscode"));var se=(a=>(a.CONFIGURATION="configuration",a.CONNECTION="connection",a.PROCESS="process",a.SYSTEM="system",a.VALIDATION="validation",a.BINARY="binary",a.UNKNOWN="unknown",a))(se||{});var ie=class ie{logger;activeProgressOperations=new Map;errorStats=new Map;config={showNotifications:!0,logLevel:"info"};constructor(e){this.logger=e,Object.values(se).forEach(t=>{this.errorStats.set(t,0)})}handleConfigurationError(e,t){let r={category:"configuration",severity:"medium",message:`Configuration error${t?` in ${t}`:""}`,userMessage:"Invalid configuration detected",suggestedActions:["Check your extension settings","Verify IP address and port format","Reset to default values if needed"],technicalDetails:e.message,originalError:e};return e.message.includes("IP address")?(r.userMessage="Invalid IP address format",r.suggestedActions=["Use format: 192.168.1.100 or localhost","Check your device's IP address in settings","Ensure device is on the same network"]):e.message.includes("port")?(r.userMessage="Invalid port number",r.suggestedActions=["Use a port number between 1 and 65535","Common ADB ports: 5555, 5037","Check your device's wireless debugging port"]):(e.message.includes("binary")||e.message.includes("path"))&&(r.category="binary",r.userMessage="Binary path configuration error",r.suggestedActions=["Check if custom binary paths exist","Verify file permissions","Reset to use bundled binaries"]),this.logAndNotifyError(r),r}handleConnectionError(e,t){let n={category:"connection",severity:"high",message:`Connection failed to ${t?`${t.ip}:${t.port}`:"device"}`,userMessage:"Failed to connect to Android device",suggestedActions:["Check device IP address and port","Ensure device is on the same network","Enable wireless debugging on device","Try connecting via USB first"],technicalDetails:e.message,originalError:e},s=e.message.toLowerCase();return s.includes("connection refused")?(n.severity="high",n.userMessage="Device refused connection",n.suggestedActions=["Enable wireless debugging on your device","Check if the port is correct","Restart ADB on your device","Try pairing the device first"]):s.includes("timeout")||s.includes("timed out")?(n.severity="medium",n.userMessage="Connection timeout",n.suggestedActions=["Check network connectivity","Move device closer to router","Restart wireless debugging","Try a different network"]):s.includes("no route to host")?(n.severity="high",n.userMessage="Device not reachable",n.suggestedActions=["Verify the IP address is correct","Check if device is on the same network","Ping the device to test connectivity","Check firewall settings"]):s.includes("unauthorized")?(n.severity="medium",n.userMessage="Device authorization required",n.suggestedActions=["Accept debugging authorization on device","Check device screen for permission dialog","Try connecting via USB first","Clear ADB keys and reconnect"]):s.includes("offline")&&(n.severity="high",n.userMessage="Device is offline",n.suggestedActions=["Check device connection","Restart wireless debugging","Reconnect device to network","Try USB connection"]),this.logAndNotifyError(n),n}handleProcessError(e,t,r){let n={category:"process",severity:"high",message:`${t} process failed`,userMessage:`Failed to execute ${t}`,suggestedActions:["Check if binaries are properly installed","Verify file permissions","Try restarting the extension","Check the logs for more details"],technicalDetails:e.message,originalError:e};return t.toLowerCase().includes("adb")?(n.userMessage="ADB command failed",n.suggestedActions=["Check if ADB is properly installed","Verify device connection","Restart ADB server","Check device authorization"]):t.toLowerCase().includes("scrcpy")&&(e.message.includes("already running")?(n.severity="medium",n.userMessage="Screen mirroring already active",n.suggestedActions=["Stop the current scrcpy instance first","Check for existing scrcpy windows","Wait a moment and try again"]):e.message.toLowerCase().includes("device not found")?(n.severity="high",n.userMessage="No device found for screen mirroring",n.suggestedActions=["Connect to device first","Check device connection status","Enable USB debugging","Try reconnecting the device"]):(n.userMessage="Screen mirroring failed",n.suggestedActions=["Check if scrcpy is properly installed","Verify device supports screen mirroring","Try connecting device via USB","Check device permissions"])),this.logAndNotifyError(n),n}handleSystemError(e,t){let r={category:"system",severity:"critical",message:`System error${t?` in ${t}`:""}`,userMessage:"System error occurred",suggestedActions:["Restart VSCode","Check system resources","Update the extension","Report the issue if it persists"],technicalDetails:e.message,originalError:e};return e.message.toLowerCase().includes("permission")?(r.category="binary",r.severity="high",r.userMessage="Permission denied",r.suggestedActions=["Check file permissions","Run VSCode with appropriate permissions","Verify binary executable permissions","Check antivirus software"]):(e.message.includes("ENOENT")||e.message.includes("not found"))&&(r.category="binary",r.severity="high",r.userMessage="Required file not found",r.suggestedActions=["Reinstall the extension","Check if binaries are present","Verify installation integrity","Check custom binary paths"]),this.logAndNotifyError(r),r}handleValidationError(e,t,r){let n={category:"validation",severity:"medium",message:`Validation failed for ${e}`,userMessage:`Invalid ${e} format`,suggestedActions:[r?`Use format: ${r}`:"Check the input format","Refer to documentation for examples","Use default values if unsure"],technicalDetails:`Invalid value: ${t}`};return e.toLowerCase().includes("ip")?n.suggestedActions=["Use format: 192.168.1.100",'Use "localhost" for local connections',"Check device network settings"]:e.toLowerCase().includes("port")&&(n.suggestedActions=["Use a number between 1 and 65535","Common ADB port: 5555","Check device wireless debugging settings"]),this.logAndNotifyError(n),n}async showProgress(e,t,r){if(r&&this.activeProgressOperations.has(r)){let s=this.activeProgressOperations.get(r);s==null||s.cancel(),this.activeProgressOperations.delete(r)}let n=new H.CancellationTokenSource;r&&this.activeProgressOperations.set(r,n);try{this.logger.info(`Starting progress operation: ${t.title}`);let s=await H.window.withProgress({location:t.location,title:t.title,cancellable:t.cancellable},async(i,a)=>{if(a.isCancellationRequested||n.token.isCancellationRequested)throw new Error("Operation cancelled by user");return await e(i,a)});return this.logger.info(`Progress operation completed: ${t.title}`),s}catch(s){throw s instanceof Error&&s.message.includes("cancelled")?(this.logger.info(`Progress operation cancelled: ${t.title}`),this.showWarning("Operation cancelled by user")):this.logger.error(`Progress operation failed: ${t.title}`,s instanceof Error?s:void 0),s}finally{r&&this.activeProgressOperations.delete(r),n.dispose()}}cancelProgress(e){let t=this.activeProgressOperations.get(e);t&&(t.cancel(),this.activeProgressOperations.delete(e),this.logger.info(`Cancelled progress operation: ${e}`))}cancelAllProgress(){for(let[e,t]of this.activeProgressOperations)t.cancel(),this.logger.info(`Cancelled progress operation: ${e}`);this.activeProgressOperations.clear()}showSuccess(e,t){let r=t?`${e} - ${t}`:e;this.logger.showSuccess(r)}showError(e,t){if(this.logger.showError(e),t&&t.length>0){let r=`Suggested actions: ${t.join(", ")}`;this.logger.info(r)}}showWarning(e){this.logger.showWarning(e)}showInfo(e){H.window.showInformationMessage(e),this.logger.info(e)}async showErrorWithActions(e,t){let r=t.map(s=>s.title),n=await H.window.showErrorMessage(e,...r);if(n){let s=t.find(i=>i.title===n);if(s)try{await s.action()}catch(i){this.logger.error("Action execution failed",i instanceof Error?i:void 0)}}}validateAndHandleInput(e,t,r){if(!e||e.trim().length===0)return{isValid:!1,error:this.handleValidationError(r,e,`Non-empty ${t}`)};let n=e.trim();if(t==="ip"){if(n==="localhost"||n==="127.0.0.1")return{isValid:!0};if(!/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(n))return{isValid:!1,error:this.handleValidationError(r,n,"192.168.1.100 or localhost")}}else if(t==="port"){let s=parseInt(n,10);if(isNaN(s)||s<1||s>65535)return{isValid:!1,error:this.handleValidationError(r,n,"1-65535")}}return{isValid:!0}}handleMultipleErrors(e,t){let r=[];for(let n of e){let s;n.message.includes("Connection failed")||n.message.includes("network")?s=this.handleConnectionError(n):n.message.includes("Invalid configuration")||n.message.includes("config")?s=this.handleConfigurationError(n):n.message.includes("Process spawn error")||n.message.includes("spawn")?s=this.handleSystemError(n,t):s=this.handleSystemError(n,t),r.push(s)}if(r.length>1){let n=`Multiple errors occurred in ${t}: ${r.length} issues found`;this.showError(n)}return r}categorizeError(e){let t=e.message.toLowerCase();return t.includes("connection")||t.includes("network")||t.includes("timeout")||t.includes("refused")||t.includes("unreachable")||t.includes("offline")||t.includes("no route to host")||t.includes("timed out")?"connection":t.includes("permission")||t.includes("enoent")||t.includes("eacces")||t.includes("binary")||t.includes("not found")||t.includes("exec format error")||t.includes("operation not permitted")?"system":t.includes("spawn")||t.includes("process")||t.includes("exited")||t.includes("emfile")||t.includes("crashed")||t.includes("memory")?"process":t.includes("invalid")||t.includes("format")||t.includes("port out of range")||t.includes("config")||t.includes("setting")?"configuration":"unknown"}assessSeverity(e){let t=e.message.toLowerCase();return t.includes("spawn enoent")||t.includes("corrupted")||t.includes("memory")||t.includes("exec format error")?"critical":t.includes("process exited")||t.includes("device not found")||t.includes("unauthorized")||t.includes("enoent")||t.includes("no such file")||t.includes("eacces")||t.includes("permission denied")?"high":t.includes("timeout")||t.includes("timed out")||t.includes("already running")||t.includes("invalid format")||t.includes("network unreachable")?"medium":"low"}getUserFriendlyMessage(e){let t=this.categorizeError(e),r=e.message.toLowerCase();switch(t){case"connection":return r.includes("refused")?"Device refused the connection. Check if wireless debugging is enabled.":r.includes("timeout")?"Connection timed out. Check your network connection.":r.includes("unreachable")?"Device is not reachable. Verify the IP address.":r.includes("offline")?"Device appears to be offline. Check device connection.":"Failed to connect to device. Check network and device settings.";case"process":return r.includes("spawn enoent")?"Required program not found. Check binary installation.":r.includes("exited")?"Process stopped unexpectedly. Check device connection.":r.includes("emfile")?"Too many files open. Close some applications and try again.":r.includes("memory")?"Not enough memory available. Close some applications.":"Process execution failed. Check system resources.";case"configuration":return r.includes("ip")||r.includes("address")?"Invalid IP address format. Use format like 192.168.1.100.":r.includes("port")?"Invalid port number. Use a number between 1 and 65535.":"Configuration error. Check your settings.";case"system":return r.includes("permission")?"Permission denied. Check file permissions or run as administrator.":r.includes("not found")?"Required file not found. Reinstall the extension.":"System error occurred. Try restarting the application.";default:return"An unexpected error occurred. Check the logs for details."}}getRecoverySuggestions(e){let t=this.categorizeError(e),r=e.message.toLowerCase();switch(t){case"connection":return r.includes("refused")?["Enable wireless debugging on your Android device","Check if the port number is correct","Try pairing the device first","Restart ADB on your device"]:r.includes("timeout")?["Check your network connection","Move device closer to the router","Try a different network","Restart wireless debugging"]:["Verify device IP address and port","Check network connectivity","Enable wireless debugging","Try USB connection first"];case"process":return["Check if required binaries are installed","Verify file permissions","Restart the application","Check system resources"];case"configuration":return["Check extension settings","Verify input format","Reset to default values","Refer to documentation"];case"system":return["Restart the application","Check file permissions","Reinstall the extension","Contact support if issue persists"];default:return["Check the logs for more details","Restart the application","Report the issue"]}}handleError(e,t){let r=this.categorizeError(e),n=this.assessSeverity(e),s=this.getUserFriendlyMessage(e),i=this.getRecoverySuggestions(e),a={category:r,severity:n,message:t?`${t}: ${e.message}`:e.message,userMessage:s,suggestedActions:i,technicalDetails:e.stack||e.message,originalError:e};return this.trackError(e),this.logAndNotifyError(a),a}trackError(e){let t=this.categorizeError(e),r=this.errorStats.get(t)||0;this.errorStats.set(t,r+1)}configure(e){e.showNotifications!==void 0&&(this.config.showNotifications=e.showNotifications),e.logLevel!==void 0&&(this.config.logLevel=e.logLevel)}getErrorStatistics(){let e={};return Object.values(se).forEach(t=>{e[t]=this.errorStats.get(t)||0}),e}logAndNotifyError(e){if(this.logger.error(`[${e.category.toUpperCase()}] ${e.message}`,e.originalError),!!this.config.showNotifications)switch(e.severity){case"critical":this.showError(e.userMessage,e.suggestedActions);break;case"high":this.showError(e.userMessage,e.suggestedActions);break;case"medium":this.showWarning(e.userMessage);break;case"low":this.showInfo(e.userMessage);break}}getErrorStats(){return this.getErrorStatistics()}getRecurringPatterns(){return[]}getErrorSummary(){let e=this.getErrorStatistics();return{totalErrors:Object.values(e).reduce((r,n)=>r+n,0),byCategory:e,recentErrors:[]}}getConfiguration(){return{...this.config}}dispose(){this.cancelAllProgress()}};d(ie,"ErrorHandler");var F=ie;var oe=class oe{processManager;configManager;logger;binaryManager;errorHandler;sidebarProvider;statusUpdateInterval;constructor(e,t,r,n,s){this.processManager=e,this.configManager=t,this.logger=r,this.binaryManager=n,this.errorHandler=new F(r),this.sidebarProvider=s,this.sidebarProvider&&this.startStatusUpdates()}registerCommands(e){[g.commands.registerCommand("droidbridge.connectDevice",(r,n)=>this.connectDeviceCommand(r,n)),g.commands.registerCommand("droidbridge.disconnectDevice",()=>this.disconnectDeviceCommand()),g.commands.registerCommand("droidbridge.launchScrcpy",()=>this.launchScrcpyCommand()),g.commands.registerCommand("droidbridge.launchScrcpyScreenOff",()=>this.launchScrcpyScreenOffCommand()),g.commands.registerCommand("droidbridge.stopScrcpy",()=>this.stopScrcpyCommand()),g.commands.registerCommand("droidbridge.showLogs",()=>this.showLogsCommand()),g.commands.registerCommand("droidbridge.checkBinaries",()=>this.checkBinariesCommand()),g.commands.registerCommand("droidbridge.downloadBinaries",()=>this.downloadBinariesCommand()),g.commands.registerCommand("droidbridge.refreshBinaries",()=>this.refreshBinariesCommand())].forEach(r=>e.subscriptions.push(r)),this.logger.info("All DroidBridge commands registered successfully")}async connectDeviceCommand(e,t){try{this.logger.info("Connect Device command executed");let r=this.configManager.getConfigWithDefaults(),n=e||r.ip,s=t||r.port;if(!e||!t){let h=await g.window.showInputBox({prompt:"Enter the IP address of your Android device",value:n,validateInput:d(p=>p.trim()?this.configManager.validateIpAddress(p.trim())?null:"Please enter a valid IP address (e.g., 192.168.1.100 or localhost)":"IP address cannot be empty","validateInput")});if(h===void 0){this.logger.info("Connect Device command cancelled by user");return}n=h.trim();let f=await g.window.showInputBox({prompt:"Enter the port number for ADB connection",value:s,validateInput:d(p=>p.trim()?this.configManager.validatePort(p.trim())?null:"Please enter a valid port number (1-65535)":"Port cannot be empty","validateInput")});if(f===void 0){this.logger.info("Connect Device command cancelled by user");return}s=f.trim()}if(!this.errorHandler.validateAndHandleInput(n,"ip","IP address").isValid||!this.errorHandler.validateAndHandleInput(s,"port","Port number").isValid)return;let u={title:`\u{1F50C} Connecting to ${n}:${s}...`,cancellable:!0,location:g.ProgressLocation.Notification};await this.errorHandler.showProgress(async(h,f)=>{if(f.isCancellationRequested)throw new Error("Connection cancelled by user");h.report({message:"Establishing connection..."});let p=await this.connectDevice(n,s);return p&&(h.report({message:"Connected successfully",increment:100}),this.logger.showSuccess(`\u2705 Device connected to ${n}:${s}`)),p},u,"connect-device")}catch(r){if(r instanceof Error&&r.message.includes("cancelled")){this.logger.info("Connect Device command cancelled by user");return}this.logger.error("Failed to execute Connect Device command",r instanceof Error?r:void 0),this.logger.showError("Failed to execute Connect Device command")}}async disconnectDeviceCommand(){try{if(this.logger.info("Disconnect Device command executed"),!this.processManager.isDeviceConnected()){this.logger.showWarning("No device is currently connected");return}let e=this.processManager.getConnectionState(),t=e.deviceIp&&e.devicePort?`${e.deviceIp}:${e.devicePort}`:"device",r={title:`\u{1F50C} Disconnecting from ${t}...`,cancellable:!1,location:g.ProgressLocation.Notification};await this.errorHandler.showProgress(async n=>{n.report({message:"Disconnecting device..."});let s=await this.disconnectDevice();return s&&(n.report({message:"Disconnected successfully",increment:100}),this.logger.showSuccess(`\u2705 Device disconnected from ${t}`)),s},r,"disconnect-device")}catch(e){this.logger.error("Failed to execute Disconnect Device command",e instanceof Error?e:void 0),this.logger.showError("Failed to execute Disconnect Device command")}}async launchScrcpyCommand(){try{if(this.logger.info("Launch Scrcpy command executed"),this.processManager.isScrcpyRunning()){this.logger.showWarning("Scrcpy is already running. Stop the current instance first.");return}if(!this.processManager.isDeviceConnected()){let t=await g.window.showWarningMessage("No device is connected. Would you like to connect to a device first?",{title:"Connect Device"},{title:"Launch Anyway"});if((t==null?void 0:t.title)==="Connect Device"&&(await this.connectDeviceCommand(),!this.processManager.isDeviceConnected()))return}let e={title:"\u{1F4F1} Launching scrcpy...",cancellable:!0,location:g.ProgressLocation.Notification};await this.errorHandler.showProgress(async(t,r)=>{if(r.isCancellationRequested)throw new Error("Scrcpy launch cancelled by user");t.report({message:"Starting screen mirroring..."});let n=await this.launchScrcpy();return n&&(t.report({message:"Screen mirroring started",increment:100}),this.logger.showSuccess("\u2705 Scrcpy launched successfully")),n},e,"launch-scrcpy")}catch(e){if(e instanceof Error&&e.message.includes("cancelled")){this.logger.info("Launch Scrcpy command cancelled by user");return}this.logger.error("Failed to execute Launch Scrcpy command",e instanceof Error?e:void 0),this.logger.showError("Failed to execute Launch Scrcpy command")}}async launchScrcpyScreenOffCommand(){try{if(this.logger.info("Launch Scrcpy Screen Off command executed"),this.processManager.isScrcpyRunning()){this.logger.showWarning("Scrcpy is already running. Stop the current instance first.");return}if(!this.processManager.isDeviceConnected()){let t=await g.window.showWarningMessage("No device is connected. Would you like to connect to a device first?",{title:"Connect Device"},{title:"Launch Anyway"});if((t==null?void 0:t.title)==="Connect Device"&&(await this.connectDeviceCommand(),!this.processManager.isDeviceConnected()))return}let e={title:"\u{1F4F1} Launching scrcpy with screen off...",cancellable:!0,location:g.ProgressLocation.Notification};await this.errorHandler.showProgress(async(t,r)=>{if(r.isCancellationRequested)throw new Error("Scrcpy screen off launch cancelled by user");t.report({message:"Starting screen mirroring with screen off..."});let n=await this.launchScrcpyScreenOff();return n&&(t.report({message:"Screen mirroring started with screen off",increment:100}),this.logger.showSuccess("\u2705 Scrcpy launched successfully with screen off")),n},e,"launch-scrcpy-screen-off")}catch(e){if(e instanceof Error&&e.message.includes("cancelled")){this.logger.info("Launch Scrcpy Screen Off command cancelled by user");return}this.logger.error("Failed to execute Launch Scrcpy Screen Off command",e instanceof Error?e:void 0),this.logger.showError("Failed to execute Launch Scrcpy Screen Off command")}}async stopScrcpyCommand(){try{if(this.logger.info("Stop Scrcpy command executed"),!this.processManager.isScrcpyRunning()){this.logger.showWarning("Scrcpy is not currently running");return}let e={title:"\u{1F4F1} Stopping scrcpy...",cancellable:!1,location:g.ProgressLocation.Notification};await this.errorHandler.showProgress(async t=>{t.report({message:"Stopping screen mirroring..."});let r=await this.stopScrcpy();return r&&(t.report({message:"Screen mirroring stopped",increment:100}),this.logger.showSuccess("\u2705 Scrcpy stopped successfully")),r},e,"stop-scrcpy")}catch(e){this.logger.error("Failed to execute Stop Scrcpy command",e instanceof Error?e:void 0),this.logger.showError("Failed to execute Stop Scrcpy command")}}showLogsCommand(){try{this.logger.info("Show Logs command executed"),this.logger.show()}catch(e){this.logger.error("Failed to execute Show Logs command",e instanceof Error?e:void 0),this.logger.showError("Failed to execute Show Logs command")}}async connectDevice(e,t){let r=this.configManager.getConfigWithDefaults(),n=e||r.ip,s=t||r.port;try{let i=this.configManager.validateConnection(n,s);if(!i.isValid){let u=`Invalid connection parameters: ${i.errors.join(", ")}`;return this.logger.showError(u),!1}if(!await this.processManager.connectDevice(n,s)){let h=this.processManager.getConnectionState().connectionError||"Failed to connect to device";return this.logger.showError(`\u274C ${h}`),this.sidebarProvider&&this.sidebarProvider.updateConnectionStatus(!1),!1}return this.sidebarProvider&&this.sidebarProvider.updateConnectionStatus(!0,n,s),!0}catch(i){return this.errorHandler.handleConnectionError(i instanceof Error?i:new Error("Unknown connection error"),{ip:n,port:s}),!1}}async disconnectDevice(){try{if(!await this.processManager.disconnectDevice()){let r=this.processManager.getConnectionState().connectionError||"Failed to disconnect from device";return this.logger.showError(`\u274C ${r}`),this.sidebarProvider&&this.sidebarProvider.updateConnectionStatus(!1),!1}return this.sidebarProvider&&this.sidebarProvider.updateConnectionStatus(!1),!0}catch(e){return this.errorHandler.handleConnectionError(e instanceof Error?e:new Error("Unknown disconnection error")),!1}}async launchScrcpy(){try{if(this.processManager.isScrcpyRunning())return this.logger.showWarning("Scrcpy is already running. Stop the current instance first."),!1;let e=await this.processManager.launchScrcpy();if(!e||!e.pid){let t=new Error("Failed to launch scrcpy - invalid process");return this.errorHandler.handleProcessError(t,"scrcpy"),this.sidebarProvider&&this.sidebarProvider.updateScrcpyStatus(!1),!1}return this.sidebarProvider&&this.sidebarProvider.updateScrcpyStatus(!0),!0}catch(e){return this.errorHandler.handleProcessError(e instanceof Error?e:new Error("Unknown scrcpy launch error"),"scrcpy"),!1}}async launchScrcpyScreenOff(){try{if(this.processManager.isScrcpyRunning())return this.logger.showWarning("Scrcpy is already running. Stop the current instance first."),!1;let e=await this.processManager.launchScrcpyScreenOff();if(!e||!e.pid){let t=new Error("Failed to launch scrcpy with screen off - invalid process");return this.errorHandler.handleProcessError(t,"scrcpy screen off"),this.sidebarProvider&&this.sidebarProvider.updateScrcpyStatus(!1),!1}return this.sidebarProvider&&this.sidebarProvider.updateScrcpyStatus(!0),!0}catch(e){return this.errorHandler.handleProcessError(e instanceof Error?e:new Error("Unknown scrcpy screen off launch error"),"scrcpy screen off"),!1}}async stopScrcpy(){try{return await this.processManager.stopScrcpy()?(this.sidebarProvider&&this.sidebarProvider.updateScrcpyStatus(!1),!0):(this.logger.showError("\u274C Failed to stop scrcpy"),!1)}catch(e){return this.errorHandler.handleProcessError(e instanceof Error?e:new Error("Unknown scrcpy stop error"),"scrcpy"),!1}}isDeviceConnected(){return this.processManager.isDeviceConnected()}isScrcpyRunning(){return this.processManager.isScrcpyRunning()}getConnectionState(){return this.processManager.getConnectionState()}getScrcpyState(){return this.processManager.getScrcpyState()}setSidebarProvider(e){this.sidebarProvider=e,this.statusUpdateInterval||this.startStatusUpdates(),this.updateSidebarState()}startStatusUpdates(){this.statusUpdateInterval||(this.statusUpdateInterval=setInterval(()=>{this.updateSidebarState()},2e3))}stopStatusUpdates(){this.statusUpdateInterval&&(clearInterval(this.statusUpdateInterval),this.statusUpdateInterval=void 0)}updateSidebarState(){if(this.sidebarProvider)try{let e=this.processManager.getConnectionState(),t=this.processManager.getScrcpyState();this.sidebarProvider.synchronizeState(e,t)}catch(e){this.logger.error("Failed to update sidebar state",e instanceof Error?e:void 0)}}refreshSidebarState(){this.updateSidebarState()}async checkBinariesCommand(){try{this.logger.info("Check Binaries command executed"),await g.window.withProgress({location:g.ProgressLocation.Notification,title:"Checking binary status...",cancellable:!1},async e=>{e.report({message:"Detecting installed binaries..."});let t=await this.binaryManager.getDetectionStatus(),r=await this.binaryManager.getBinaryInfo(),n=await this.binaryManager.needsDownload();e.report({message:"Analysis complete",increment:100});let s=[];s.push(`=== DroidBridge Binary Status ===
`);let i=t.get("adb");s.push(`ADB: ${i!=null&&i.found?"\u2705 Found":"\u274C Not Found"}`),i!=null&&i.found&&(s.push(`  Path: ${i.path}`),s.push(`  Source: ${this.getSourceDescription(i.source)}`),i.version&&s.push(`  Version: ${i.version}`));let a=t.get("scrcpy");s.push(`
Scrcpy: ${a!=null&&a.found?"\u2705 Found":"\u274C Not Found"}`),a!=null&&a.found&&(s.push(`  Path: ${a.path}`),s.push(`  Source: ${this.getSourceDescription(a.source)}`),a.version&&s.push(`  Version: ${a.version}`)),n.needed?(s.push(`
\u26A0\uFE0F  Missing binaries: ${n.binaries.join(", ")}`),s.push('Use "DroidBridge: Download Binaries" to download missing binaries.')):s.push(`
\u2705 All required binaries are available`);let u=s.join(`
`);this.logger.info("Binary status check completed"),this.logger.info(u);let h=n.needed?"Download Missing":"Show Logs",f=await g.window.showInformationMessage(n.needed?`Missing binaries: ${n.binaries.join(", ")}. Download them now?`:"All binaries are available. Check logs for details.",h,"Show Logs");f==="Download Missing"?await this.downloadBinariesCommand():f==="Show Logs"&&this.logger.show()})}catch(e){this.errorHandler.handleSystemError(e instanceof Error?e:new Error("Unknown binary check error"),"Check Binaries command")}}async downloadBinariesCommand(){try{this.logger.info("Download Binaries command executed");let e=await this.binaryManager.needsDownload();if(!e.needed){g.window.showInformationMessage("All required binaries are already available.");return}if(await g.window.showWarningMessage(`This will download missing binaries: ${e.binaries.join(", ")}. Continue?`,{modal:!0},"Download","Cancel")!=="Download"){this.logger.info("Download Binaries command cancelled by user");return}await g.window.withProgress({location:g.ProgressLocation.Notification,title:"Downloading binaries...",cancellable:!1},async r=>{this.binaryManager.setDownloadProgressCallback(s=>{r.report({message:`Downloading ${s.binary}: ${s.percentage}%`,increment:s.percentage/e.binaries.length})});let n=await this.binaryManager.ensureBinariesAvailable();if(n.success)r.report({message:"Download completed successfully",increment:100}),this.errorHandler.showSuccess("All binaries downloaded successfully"),this.sidebarProvider&&this.sidebarProvider.refresh();else throw new Error(`Download failed: ${n.errors.join(", ")}`)})}catch(e){this.errorHandler.handleSystemError(e instanceof Error?e:new Error("Unknown download error"),"Download Binaries command")}}async refreshBinariesCommand(){try{this.logger.info("Refresh Binaries command executed"),await g.window.withProgress({location:g.ProgressLocation.Notification,title:"Refreshing binary detection...",cancellable:!1},async e=>{e.report({message:"Clearing detection cache..."}),await this.binaryManager.refreshDetection(),e.report({message:"Re-detecting binaries...",increment:50});let t=await this.binaryManager.getDetectionStatus();e.report({message:"Detection refreshed",increment:100});let r=Array.from(t.entries()).filter(([n,s])=>s.found).map(([n,s])=>n);this.errorHandler.showSuccess(r.length>0?`Binary detection refreshed. Found: ${r.join(", ")}`:"Binary detection refreshed. No binaries found."),this.sidebarProvider&&this.sidebarProvider.refresh()})}catch(e){this.errorHandler.handleSystemError(e instanceof Error?e:new Error("Unknown refresh error"),"Refresh Binaries command")}}getSourceDescription(e){switch(e){case"system":return"System PATH";case"bundled":return"Bundled with extension";case"downloaded":return"Downloaded by extension";case"custom":return"Custom path (user configured)";case"not-found":return"Not found";default:return e}}dispose(){this.stopStatusUpdates(),this.errorHandler.dispose()}};d(oe,"CommandManager");var K=oe;var ce=require("child_process");var E=y(require("os")),ye=y(require("path"));var ae=class ae{static getBinaryExtension(){return E.platform()==="win32"?".exe":""}static getBinaryPath(e){return`${e}${this.getBinaryExtension()}`}static async makeExecutable(e){if(E.platform()!=="win32"){let t=await import("fs/promises");try{let n=(await t.stat(e)).mode,s=n|73;n!==s&&await t.chmod(e,s)}catch(r){throw new Error(`Failed to make ${e} executable: ${r instanceof Error?r.message:String(r)}`)}}}static async isExecutable(e){if(E.platform()==="win32"){let r=await import("fs/promises");try{return await r.access(e),!0}catch{return!1}}let t=await import("fs/promises");try{return await t.access(e,t.constants.F_OK|t.constants.X_OK),!0}catch{return!1}}static getPlatformSpecificOptions(e={}){let t={stdio:["pipe","pipe","pipe"],...e};switch(E.platform()){case"win32":return{...t,shell:!0,windowsHide:!0,env:{...process.env,...t.env}};case"darwin":return{...t,env:{...process.env,...t.env}};case"linux":return{...t,env:{...process.env,...t.env}};default:return t}}static getCurrentPlatform(){let e=E.platform();switch(e){case"win32":return"win32";case"darwin":return"darwin";case"linux":return"linux";default:throw new Error(`Unsupported platform: ${e}`)}}static getCurrentArchitecture(){let e=E.arch();switch(e){case"x64":return"x64";case"arm64":return"arm64";case"ia32":return"x86";default:return e}}static getPlatformBinaryDir(){let e=this.getCurrentPlatform(),t=this.getCurrentArchitecture();return e}static normalizePath(e){return ye.normalize(e)}static supportsFeature(e){let t=E.platform();switch(e){case"executable-permissions":return t!=="win32";case"shell-execution":return!0;case"process-signals":return t!=="win32";default:return!1}}static getTerminationSignal(){return E.platform()==="win32","SIGTERM"}static getForceKillSignal(){return E.platform()==="win32","SIGKILL"}static getTempDir(){return E.tmpdir()}static isSupportedPlatform(){try{return this.getCurrentPlatform(),!0}catch{return!1}}};d(ae,"PlatformUtils");var c=ae;var de=class de{scrcpyProcess=null;managedProcesses=new Set;binaryManager;logger;errorHandler;connectionState;scrcpyState;constructor(e,t){this.binaryManager=e,this.logger=t,this.errorHandler=new F(t),this.connectionState={connected:!1},this.scrcpyState={running:!1}}async executeAdbCommand(e){var r,n,s,i;let t;try{t=await this.binaryManager.getAdbPath()}catch{t=((n=(r=this.binaryManager).getAdbPathSync)==null?void 0:n.call(r))||((i=(s=this.binaryManager).getBundledBinaryPath)==null?void 0:i.call(s,"adb"))||"adb"}return new Promise(a=>{var m,B;let u="",h="";this.logger.info(`Executing ADB command: ${t} ${e.join(" ")}`);let f=c.getPlatformSpecificOptions({stdio:["pipe","pipe","pipe"]}),p=(0,ce.spawn)(t,e,f);this.managedProcesses.add(p),(m=p.stdout)==null||m.on("data",D=>{let I=D.toString();u+=I,this.logger.logProcessOutput("adb",I)}),(B=p.stderr)==null||B.on("data",D=>{let I=D.toString();h+=I,this.logger.logProcessOutput("adb",I)}),p.on("close",D=>{this.managedProcesses.delete(p);let I=D??-1,k={success:I===0,stdout:u.trim(),stderr:h.trim(),exitCode:I};this.logger.info(`ADB command completed with exit code: ${I}`),a(k)}),p.on("error",D=>{this.managedProcesses.delete(p),this.logger.error(`ADB process error: ${D.message}`,D),a({success:!1,stdout:u.trim(),stderr:D.message,exitCode:-1})})})}async connectDevice(e,t){var r,n;try{let s=this.errorHandler.validateAndHandleInput(e,"ip","IP address");if(!s.isValid)return this.connectionState={connected:!1,connectionError:((r=s.error)==null?void 0:r.userMessage)||"Invalid IP address"},!1;let i=this.errorHandler.validateAndHandleInput(t,"port","Port number");if(!i.isValid)return this.connectionState={connected:!1,connectionError:((n=i.error)==null?void 0:n.userMessage)||"Invalid port number"},!1;let a=`${e}:${t}`;this.logger.info(`Attempting to connect to device at ${a}`);let u=await this.executeAdbCommand(["connect",a]);if(u.success){if(this.parseConnectResult(u.stdout,a))return this.connectionState={connected:!0,deviceIp:e,devicePort:t,lastConnected:new Date,connectionError:void 0},this.logger.info(`Successfully connected to device at ${a}`),!0;{let f=this.extractConnectionError(u.stdout,u.stderr);return this.connectionState={connected:!1,connectionError:f},this.logger.error(`Failed to connect to device at ${a}: ${f}`),!1}}else{let h=this.extractConnectionError(u.stdout,u.stderr);return this.connectionState={connected:!1,connectionError:h},this.logger.error(`ADB connect command failed: ${h}`),!1}}catch(s){let i=s instanceof Error?s.message:"Unknown error";return this.logger.error(`Connection attempt failed: ${i}`,s instanceof Error?s:void 0),this.connectionState={connected:!1,connectionError:i},!1}}async disconnectDevice(){try{if(!this.connectionState.connected||!this.connectionState.deviceIp||!this.connectionState.devicePort)return this.logger.info("No device currently connected"),!0;let e=`${this.connectionState.deviceIp}:${this.connectionState.devicePort}`;this.logger.info(`Attempting to disconnect from device at ${e}`);let t=await this.executeAdbCommand(["disconnect",e]);if(t.success)return this.connectionState={connected:!1,connectionError:void 0},this.logger.info(`Successfully disconnected from device at ${e}`),!0;{let r=this.extractConnectionError(t.stdout,t.stderr);return this.logger.error(`Failed to disconnect from device: ${r}`),this.connectionState={connected:!1,connectionError:r},!1}}catch(e){let t=e instanceof Error?e.message:"Unknown error";return this.logger.error(`Disconnect attempt failed: ${t}`,e instanceof Error?e:void 0),this.connectionState={connected:!1,connectionError:t},!1}}async checkDeviceConnectivity(){try{this.logger.info("Checking device connectivity");let e=await this.executeAdbCommand(["devices"]);if(!e.success)return this.logger.error("Failed to check device connectivity"),this.connectionState={...this.connectionState,connected:!1,connectionError:"Failed to query ADB devices"},!1;let t=this.parseDevicesOutput(e.stdout);return t!==this.connectionState.connected&&(this.connectionState={...this.connectionState,connected:t,connectionError:t?void 0:"Device no longer connected"},this.logger.info(`Device connectivity status updated: ${t?"connected":"disconnected"}`)),t}catch(e){let t=e instanceof Error?e.message:"Unknown error";return this.logger.error(`Connectivity check failed: ${t}`,e instanceof Error?e:void 0),this.connectionState={...this.connectionState,connected:!1,connectionError:t},!1}}getConnectionState(){return{...this.connectionState}}isDeviceConnected(){return this.connectionState.connected}async launchScrcpy(e){return this.launchScrcpyWithCustomArgs(e)}async stopScrcpy(){return this.scrcpyProcess?new Promise(e=>{let t=this.scrcpyProcess;this.logger.info("Stopping scrcpy process");let r=d(()=>{this.managedProcesses.delete(t),this.scrcpyProcess=null,this.scrcpyState={running:!1},this.logger.info("Scrcpy process stopped successfully"),e(!0)},"cleanup"),n=setTimeout(()=>{if(t&&!t.killed){this.logger.info("Force killing scrcpy process");let s=c.getForceKillSignal();t.kill(s)}r()},3e3);if(t.on("close",()=>{clearTimeout(n),r()}),t&&!t.killed){let s=c.getTerminationSignal();t.kill(s)}else clearTimeout(n),r()}):(this.scrcpyState={running:!1},!0)}isScrcpyRunning(){let e=this.scrcpyProcess!==null&&!this.scrcpyProcess.killed;return this.scrcpyState.running!==e&&(this.scrcpyState={...this.scrcpyState,running:e}),e}getScrcpyState(){return this.isScrcpyRunning(),{...this.scrcpyState}}getScrcpyUptime(){return!this.isScrcpyRunning()||!this.scrcpyState.startTime?null:Date.now()-this.scrcpyState.startTime.getTime()}monitorScrcpyProcess(){if(!this.scrcpyProcess)return;let e=this.scrcpyProcess;(e.killed||e.exitCode!==null)&&(this.logger.info("Detected scrcpy process termination during monitoring"),this.managedProcesses.delete(e),this.scrcpyProcess=null,this.scrcpyState={running:!1})}async cleanup(){this.logger.info("Cleaning up all managed processes");let e=[];this.isScrcpyRunning()&&e.push(this.stopScrcpy().then(()=>{}));for(let t of this.managedProcesses)t.killed||e.push(new Promise(r=>{t.on("close",()=>r());let n=c.getTerminationSignal();t.kill(n),setTimeout(()=>{if(!t.killed){let s=c.getForceKillSignal();t.kill(s)}r()},2e3)}));await Promise.all(e),this.managedProcesses.clear(),this.scrcpyProcess=null,this.scrcpyState={running:!1},this.logger.info("Process cleanup completed")}isValidIpAddress(e){return/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)}isValidPort(e){let t=parseInt(e,10);return!isNaN(t)&&t>=1&&t<=65535}parseConnectResult(e,t){let r=e.toLowerCase();return r.includes("connected to")||r.includes("already connected")?!0:(r.includes("failed to connect")||r.includes("cannot connect")||r.includes("connection refused")||r.includes("no route to host")||r.includes("timeout"),!1)}parseDevicesOutput(e){if(!this.connectionState.deviceIp||!this.connectionState.devicePort)return!1;let t=`${this.connectionState.deviceIp}:${this.connectionState.devicePort}`,r=e.split(`
`);for(let n of r){let s=n.trim();if(s.startsWith(t)&&s.includes("device"))return!0}return!1}extractConnectionError(e,t){let r=(e+" "+t).toLowerCase();return r.includes("connection refused")?"Connection refused. Make sure the device is reachable and ADB debugging is enabled.":r.includes("no route to host")?"No route to host. Check the IP address and network connectivity.":r.includes("timeout")||r.includes("timed out")?"Connection timeout. The device may be unreachable or busy.":r.includes("failed to connect")?"Failed to connect to device. Verify the IP address and port are correct.":r.includes("cannot connect")?"Cannot connect to device. Check if wireless debugging is enabled.":r.includes("device offline")?"Device is offline. Try reconnecting the device.":r.includes("unauthorized")?"Device unauthorized. Please accept the debugging authorization on your device.":t.trim()||e.trim()||"Unknown connection error occurred."}async launchScrcpyScreenOff(e){let t={...e};return this.logger.info("Launching scrcpy with screen off functionality"),this.launchScrcpyWithCustomArgs(t,["--turn-screen-off"])}async launchScrcpyWithCustomArgs(e,t=[]){var s,i,a,u;if(this.isScrcpyRunning())throw new Error("Scrcpy is already running. Stop the current instance first.");let r;try{r=await this.binaryManager.getScrcpyPath()}catch{r=((i=(s=this.binaryManager).getScrcpyPathSync)==null?void 0:i.call(s))||((u=(a=this.binaryManager).getBundledBinaryPath)==null?void 0:u.call(a,"scrcpy"))||"scrcpy"}let n=[...this.buildScrcpyArgs(e),...t];return this.logger.info(`Launching scrcpy: ${r} ${n.join(" ")}`),this.scrcpyState={running:!1,startTime:new Date,options:e?{...e}:void 0},new Promise((h,f)=>{var I,ne;let p=c.getPlatformSpecificOptions({stdio:["pipe","pipe","pipe"],detached:!1}),m=(0,ce.spawn)(r,n,p);this.scrcpyProcess=m,this.managedProcesses.add(m);let B=!1,D=d(k=>{let Be=k.toString();this.logger.logProcessOutput("scrcpy",Be),B||(B=!0,this.scrcpyState={running:!0,process:m,startTime:this.scrcpyState.startTime,options:this.scrcpyState.options},this.logger.info("Scrcpy process started successfully"),h(m))},"onData");(I=m.stdout)==null||I.on("data",D),(ne=m.stderr)==null||ne.on("data",D),m.on("close",k=>{this.managedProcesses.delete(m),this.scrcpyProcess===m&&(this.scrcpyProcess=null,this.scrcpyState={running:!1}),this.logger.info(`Scrcpy process closed with exit code: ${k}`)}),m.on("error",k=>{this.managedProcesses.delete(m),this.scrcpyProcess===m&&(this.scrcpyProcess=null,this.scrcpyState={running:!1}),this.logger.error(`Scrcpy process error: ${k.message}`,k),B||(B=!0,f(k))}),setTimeout(()=>{B||(B=!0,this.scrcpyState={running:!1},f(new Error("Scrcpy failed to start within timeout period")))},5e3)})}buildScrcpyArgs(e){let t=[];return e!=null&&e.bitrate&&t.push("--bit-rate",e.bitrate.toString()),e!=null&&e.maxSize&&t.push("--max-size",e.maxSize.toString()),e!=null&&e.crop&&t.push("--crop",e.crop),e!=null&&e.recordFile&&t.push("--record",e.recordFile),t}};d(de,"ProcessManager");var G=de;var w=y(require("vscode"));var v=class v{getDefaultIp(){return w.workspace.getConfiguration(v.CONFIG_SECTION).get("defaultIp",v.DEFAULT_IP).trim()||v.DEFAULT_IP}getDefaultPort(){return w.workspace.getConfiguration(v.CONFIG_SECTION).get("defaultPort",v.DEFAULT_PORT).trim()||v.DEFAULT_PORT}getCustomAdbPath(){return w.workspace.getConfiguration(v.CONFIG_SECTION).get("adbPath","").trim()||void 0}getCustomScrcpyPath(){return w.workspace.getConfiguration(v.CONFIG_SECTION).get("scrcpyPath","").trim()||void 0}getValidatedConfig(){let e=this.getDefaultIp(),t=this.getDefaultPort(),r=this.getCustomAdbPath(),n=this.getCustomScrcpyPath(),s=[];return this.validateIpAddress(e)||s.push(`Invalid IP address: ${e}`),this.validatePort(t)||s.push(`Invalid port: ${t}`),{defaultIp:e,defaultPort:t,customAdbPath:r,customScrcpyPath:n,isValid:s.length===0,errors:s}}validateIpAddress(e){if(!e||typeof e!="string")return!1;let t=e.trim();return t==="localhost"||t==="127.0.0.1"?!0:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$/.test(t)?t.split(".").every(s=>{if(s.length>1&&s.startsWith("0"))return!1;let i=parseInt(s,10);return i>=0&&i<=255}):!1}validatePort(e){if(e==null)return!1;let t;if(typeof e=="string"){let r=e.trim();if(r===""||r.includes(".")||!/^\d+$/.test(r)||r.length>1&&r.startsWith("0"))return!1;t=parseInt(r,10)}else t=e;return!isNaN(t)&&Number.isInteger(t)&&t>=1&&t<=65535}validateConnection(e,t){let r=[];return this.validateIpAddress(e)||r.push(`Invalid IP address: ${e}. Must be a valid IPv4 address or 'localhost'.`),this.validatePort(t)||r.push(`Invalid port: ${t}. Must be a number between 1 and 65535.`),{isValid:r.length===0,errors:r}}getConfigWithDefaults(){let e=this.getDefaultIp(),t=this.getDefaultPort();return{ip:this.validateIpAddress(e)?e:v.DEFAULT_IP,port:this.validatePort(t)?t:v.DEFAULT_PORT}}onConfigurationChanged(e){return w.workspace.onDidChangeConfiguration(t=>{t.affectsConfiguration(v.CONFIG_SECTION)&&e()})}async updateConfig(e,t,r=w.ConfigurationTarget.Workspace){await w.workspace.getConfiguration(v.CONFIG_SECTION).update(e,t,r)}async resetToDefaults(){let e=w.workspace.getConfiguration(v.CONFIG_SECTION);await Promise.all([e.update("defaultIp",void 0,w.ConfigurationTarget.Workspace),e.update("defaultPort",void 0,w.ConfigurationTarget.Workspace),e.update("adbPath",void 0,w.ConfigurationTarget.Workspace),e.update("scrcpyPath",void 0,w.ConfigurationTarget.Workspace)])}};d(v,"ConfigManager"),C(v,"CONFIG_SECTION","droidbridge"),C(v,"DEFAULT_IP","192.168.1.100"),C(v,"DEFAULT_PORT","5555");var j=v;var Ie=y(require("path")),he=y(require("fs/promises"));var Ee=require("child_process"),Pe=require("util"),le=y(require("path")),ue=y(require("fs/promises"));var Ne=[{name:"adb",downloadUrls:{github:"https://github.com/Lusan-sapkota/droidbridge-binaries/releases/latest/download",fallback:"https://dl.google.com/android/repository/platform-tools-latest"},version:"latest"},{name:"scrcpy",downloadUrls:{github:"https://github.com/Lusan-sapkota/droidbridge-binaries/releases/latest/download",fallback:"https://github.com/Genymobile/scrcpy/releases/latest/download"},version:"latest"}];function ee(o){return Ne.find(e=>e.name===o)}d(ee,"getBinaryConfig");function ve(o,e="github"){let t=ee(o);if(t)return t.downloadUrls[e]||t.downloadUrls.github||t.downloadUrls.direct}d(ve,"getDownloadUrl");var He={adb:{win32:"adb-windows-{arch}.exe",darwin:"adb-macos-{arch}",linux:"adb-linux-{arch}"},scrcpy:{win32:"scrcpy-windows-{arch}.exe",darwin:"scrcpy-macos-{arch}",linux:"scrcpy-linux-{arch}"}};function be(o,e,t){var n;let r=(n=He[o])==null?void 0:n[e];return r?r.replace("{arch}",t):`${o}-${e}-${t}${e==="win32"?".exe":""}`}d(be,"getBinaryPattern");var we=(0,Pe.promisify)(Ee.exec),Se,Ce,O=class O{downloadDir;constructor(e){this.downloadDir=le.join(e,"downloaded-binaries")}async detectBinaries(){let e=new Map;for(let t of O.BINARY_REQUIREMENTS){let r=await this.detectSingleBinary(t.name);e.set(t.name,r)}return e}async detectSingleBinary(e){let t=await this.checkSystemPath(e);if(t.found)return t;let r=await this.checkDownloadedBinary(e);if(r.found)return r;let n=await this.checkCommonPaths(e);return n.found?n:{found:!1,source:"not-found"}}async getMissingBinaries(){let e=await this.detectBinaries(),t=[];for(let r of O.BINARY_REQUIREMENTS){let n=e.get(r.name);!(n!=null&&n.found)&&r.required&&t.push(r)}return t}async checkSystemPath(e){try{let t=c.getCurrentPlatform()==="win32"?"where":"which",{stdout:r}=await we(`${t} ${e}`),n=r.trim().split(`
`)[0];if(n){let s=await this.getBinaryVersion(e,n);return{found:!0,path:n,version:s,source:"system"}}}catch{}return{found:!1,source:"not-found"}}async checkDownloadedBinary(e){try{let t=c.getCurrentPlatform(),r=c.getBinaryExtension(),n=le.join(this.downloadDir,t,`${e}${r}`);if(await ue.access(n),c.supportsFeature("executable-permissions")&&!await c.isExecutable(n))return{found:!1,source:"not-found"};let s=await this.getBinaryVersion(e,n);return{found:!0,path:n,version:s,source:"downloaded"}}catch{return{found:!1,source:"not-found"}}}async checkCommonPaths(e){let t=c.getCurrentPlatform(),r=c.getBinaryExtension(),n=[];switch(t){case"win32":n=[`C:\\Program Files\\${e}\\${e}${r}`,`C:\\Program Files (x86)\\${e}\\${e}${r}`,`C:\\${e}\\${e}${r}`,`C:\\tools\\${e}\\${e}${r}`];break;case"darwin":n=[`/usr/local/bin/${e}`,`/opt/homebrew/bin/${e}`,`/Applications/${e}/${e}`,`${process.env.HOME}/bin/${e}`];break;case"linux":n=[`/usr/bin/${e}`,`/usr/local/bin/${e}`,`/opt/${e}/${e}`,`${process.env.HOME}/.local/bin/${e}`,`${process.env.HOME}/bin/${e}`];break}for(let s of n)try{if(await ue.access(s),c.supportsFeature("executable-permissions")&&!await c.isExecutable(s))continue;let i=await this.getBinaryVersion(e,s);return{found:!0,path:s,version:i,source:"system"}}catch{}return{found:!1,source:"not-found"}}async getBinaryVersion(e,t){try{let r;switch(e){case"adb":r=`"${t}" version`;break;case"scrcpy":r=`"${t}" --version`;break;default:return}let{stdout:n}=await we(r),s=n.match(/(\d+\.\d+\.\d+)/);return s?s[1]:n.trim().split(`
`)[0]}catch{return}}getDownloadDir(){return this.downloadDir}static getBinaryRequirements(){return[...O.BINARY_REQUIREMENTS]}};d(O,"BinaryDetector"),C(O,"BINARY_REQUIREMENTS",[{name:"adb",required:!0,downloadUrl:(Se=ee("adb"))==null?void 0:Se.downloadUrls.github},{name:"scrcpy",required:!0,downloadUrl:(Ce=ee("scrcpy"))==null?void 0:Ce.downloadUrls.github}]);var A=O;var Fe=y(require("https")),We=y(require("http")),T=y(require("fs/promises")),Y=y(require("path")),De=require("fs");var ge=class ge{downloadDir;progressCallback;constructor(e){this.downloadDir=e}setProgressCallback(e){this.progressCallback=e}async downloadBinaries(e){let t=[];await this.ensureDownloadDirectory();for(let r of e){let n=await this.downloadSingleBinary(r);t.push(n)}return t}async downloadSingleBinary(e){try{if(!e.downloadUrl)return{success:!1,binary:e.name,error:"No download URL provided"};let t=this.getDownloadUrl(e),r=this.getOutputPath(e.name);return await T.mkdir(Y.dirname(r),{recursive:!0}),await this.downloadFile(t,r,e.name),c.supportsFeature("executable-permissions")&&await c.makeExecutable(r),{success:!0,binary:e.name,path:r}}catch(t){return{success:!1,binary:e.name,error:t instanceof Error?t.message:String(t)}}}async isBinaryDownloaded(e){try{let t=this.getOutputPath(e);return await T.access(t),c.supportsFeature("executable-permissions")?await c.isExecutable(t):!0}catch{return!1}}getDownloadedBinaryPath(e){return this.getOutputPath(e)}async cleanupDownloads(){try{await T.rm(this.downloadDir,{recursive:!0,force:!0})}catch{}}getDownloadUrl(e){let t=c.getCurrentPlatform(),r=c.getCurrentArchitecture(),n=ve(e.name,"github");if(n){let s=be(e.name,t,r);return`${n}/${s}`}if(e.downloadUrl){let s=c.getBinaryExtension(),i=`${e.name}-${t}-${r}${s}`;return e.downloadUrl.includes("github.com")?`${e.downloadUrl}/${i}`:`${e.downloadUrl}/${i}`}throw new Error(`No download URL configured for ${e.name}`)}getOutputPath(e){let t=c.getCurrentPlatform(),r=c.getBinaryExtension();return Y.join(this.downloadDir,t,`${e}${r}`)}async ensureDownloadDirectory(){let e=c.getCurrentPlatform(),t=Y.join(this.downloadDir,e);await T.mkdir(t,{recursive:!0})}async downloadFile(e,t,r){return new Promise((n,s)=>{let a=(e.startsWith("https:")?Fe:We).get(e,u=>{if(u.statusCode===302||u.statusCode===301){let m=u.headers.location;if(m){this.downloadFile(m,t,r).then(n).catch(s);return}}if(u.statusCode!==200){s(new Error(`Download failed with status ${u.statusCode}`));return}let h=parseInt(u.headers["content-length"]||"0",10),f=0,p=(0,De.createWriteStream)(t);u.on("data",m=>{f+=m.length,this.progressCallback&&h>0&&this.progressCallback({binary:r,downloaded:f,total:h,percentage:Math.round(f/h*100)})}),u.pipe(p),p.on("finish",()=>{p.close(),n()}),p.on("error",m=>{T.unlink(t).catch(()=>{}),s(m)})});a.on("error",u=>{s(u)}),a.setTimeout(3e4,()=>{a.destroy(),s(new Error("Download timeout"))})})}};d(ge,"BinaryDownloader");var q=ge;var pe=class pe{extensionPath;configManager;binaryDetector;binaryDownloader;detectionCache=new Map;downloadProgressCallback;constructor(e,t){this.extensionPath=e,this.configManager=t,this.binaryDetector=new A(e),this.binaryDownloader=new q(this.binaryDetector.getDownloadDir())}setDownloadProgressCallback(e){this.downloadProgressCallback=e,this.binaryDownloader.setProgressCallback(e)}async getAdbPath(){let e=this.configManager.getCustomAdbPath();if(e)return e;let t=await this.getOrDetectBinary("adb");if(t.found&&t.path)return t.path;throw new Error("ADB binary not found. Please install ADB or set a custom path in settings.")}async getScrcpyPath(){let e=this.configManager.getCustomScrcpyPath();if(e)return e;let t=await this.getOrDetectBinary("scrcpy");if(t.found&&t.path)return t.path;throw new Error("Scrcpy binary not found. Please install scrcpy or set a custom path in settings.")}getAdbPathSync(){let e=this.configManager.getCustomAdbPath();return e||this.getBundledBinaryPath("adb")}getScrcpyPathSync(){let e=this.configManager.getCustomScrcpyPath();return e||this.getBundledBinaryPath("scrcpy")}async ensureBinariesAvailable(){let e=[];try{let t=await this.getDetectionStatus(),r=[];for(let s of A.getBinaryRequirements()){let i=t.get(s.name);i!=null&&i.found||r.push(s)}if(r.length===0)return{success:!0,errors:[]};let n=await this.binaryDownloader.downloadBinaries(r);for(let s of n)s.success||e.push(`Failed to download ${s.binary}: ${s.error}`);return this.detectionCache.clear(),{success:e.length===0,errors:e}}catch(t){return e.push(`Binary management error: ${t instanceof Error?t.message:String(t)}`),{success:!1,errors:e}}}async validateBinaries(){let e=[],t=!1,r=!1;try{let n=await this.ensureBinariesAvailable();n.success||e.push(...n.errors);try{let s=await this.getAdbPath();t=await this.validateBinary(s,"adb"),t||e.push(`ADB binary not found or not executable: ${s}`)}catch(s){e.push(`Error validating ADB binary: ${s instanceof Error?s.message:String(s)}`)}try{let s=await this.getScrcpyPath();r=await this.validateBinary(s,"scrcpy"),r||e.push(`Scrcpy binary not found or not executable: ${s}`)}catch(s){e.push(`Error validating scrcpy binary: ${s instanceof Error?s.message:String(s)}`)}}catch(n){e.push(`Binary validation error: ${n instanceof Error?n.message:String(n)}`)}return{adbValid:t,scrcpyValid:r,errors:e}}async getBinaryInfo(){let e=this.configManager.getCustomAdbPath(),t=this.configManager.getCustomScrcpyPath(),r=await this.getOrDetectBinary("adb"),n=await this.getOrDetectBinary("scrcpy");return{adb:{path:e||r.path||"Not found",isCustom:!!e,bundledPath:this.getBundledBinaryPath("adb"),source:e?"custom":r.source,version:r.version},scrcpy:{path:t||n.path||"Not found",isCustom:!!t,bundledPath:this.getBundledBinaryPath("scrcpy"),source:t?"custom":n.source,version:n.version}}}async getDetectionStatus(){let e=new Map;for(let t of A.getBinaryRequirements()){let r=await this.getOrDetectBinary(t.name);e.set(t.name,r)}return e}async refreshDetection(){this.detectionCache.clear()}async needsDownload(){let e=await this.getDetectionStatus(),t=[];for(let r of A.getBinaryRequirements()){let n=e.get(r.name);n!=null&&n.found||t.push(r.name)}return{needed:t.length>0,binaries:t}}async checkBinaryIntegrity(){let e=[],t=!1,r=!1;try{if(!c.isSupportedPlatform())return e.push(`Unsupported platform: ${c.getCurrentPlatform()}`),{adb:!1,scrcpy:!1,errors:e};let n=await this.getAdbPath();t=await this.checkSingleBinaryIntegrity(n,"adb"),t||e.push(`ADB binary integrity check failed: ${n}`);let s=await this.getScrcpyPath();r=await this.checkSingleBinaryIntegrity(s,"scrcpy"),r||e.push(`Scrcpy binary integrity check failed: ${s}`)}catch(n){e.push(`Binary integrity check failed: ${n instanceof Error?n.message:String(n)}`)}return{adb:t,scrcpy:r,errors:e}}getPlatformInfo(){return{platform:c.getCurrentPlatform(),architecture:c.getCurrentArchitecture(),binaryExtension:c.getBinaryExtension(),supportsExecutablePermissions:c.supportsFeature("executable-permissions")}}async getOrDetectBinary(e){if(this.detectionCache.has(e))return this.detectionCache.get(e);let t=await this.binaryDetector.detectSingleBinary(e);return this.detectionCache.set(e,t),t}getBundledBinaryPath(e){let t=c.getCurrentPlatform(),r=c.getBinaryExtension();return Ie.join(this.extensionPath,"binaries",t,`${e}${r}`)}async validateBinary(e,t){try{if(!(await he.stat(e)).isFile())return!1;if(c.supportsFeature("executable-permissions")&&!await c.isExecutable(e))try{await c.makeExecutable(e)}catch{return!1}return!0}catch{return!1}}async checkSingleBinaryIntegrity(e,t){try{let r=await he.stat(e);if(!r.isFile()||r.size===0)return!1;if(c.getCurrentPlatform()==="win32"){let s=c.getBinaryExtension();if(s&&!e.endsWith(s))return!1}else if(!await c.isExecutable(e))try{return await c.makeExecutable(e),await c.isExecutable(e)}catch{return!1}return!0}catch{return!1}}};d(pe,"BinaryManager");var _=pe;var M=y(require("vscode"));var fe=class fe{outputChannel;logLevel=1;constructor(){this.outputChannel=M.window.createOutputChannel("DroidBridge Logs")}setLogLevel(e){this.logLevel=e}getLogLevel(){return this.logLevel}formatTimestamp(){return new Date().toISOString().replace("T"," ").replace("Z","")}debug(e){if(this.logLevel<=0){let t=this.formatTimestamp();this.outputChannel.appendLine(`[${t}] DEBUG: ${e}`)}}info(e){if(this.logLevel<=1){let t=this.formatTimestamp();this.outputChannel.appendLine(`[${t}] INFO: ${e}`)}}error(e,t){let n=`[${this.formatTimestamp()}] ERROR: ${e}`;t&&(n+=`
Error Details: ${t.message}`,t.stack&&(n+=`
Stack Trace:
${t.stack}`)),this.outputChannel.appendLine(n)}logProcessOutput(e,t,r=!1){let n=this.formatTimestamp(),s=r?"STDERR":"STDOUT";this.outputChannel.appendLine(`[${n}] PROCESS ${s}: ${e}`),t.trim()&&t.trim().split(`
`).forEach(a=>{this.outputChannel.appendLine(`  ${a}`)}),this.outputChannel.appendLine("")}showProgress(e){return this.info(`Progress: ${e}`),M.window.withProgress({location:M.ProgressLocation.Notification,title:e,cancellable:!1},async()=>{})}showProgressWithCancel(e,t=!0){return this.info(`Progress (cancellable): ${e}`),M.window.withProgress({location:M.ProgressLocation.Notification,title:e,cancellable:t},async(r,n)=>new Promise((s,i)=>{n.isCancellationRequested&&i(new Error("Operation cancelled by user")),s()}))}showSuccess(e){M.window.showInformationMessage(e),this.info(`SUCCESS: ${e}`)}showError(e,t){let r=e;t&&(r+=` (${t.message})`),M.window.showErrorMessage(r),this.error(`USER ERROR: ${e}`,t)}showWarning(e){M.window.showWarningMessage(e),this.info(`WARNING: ${e}`)}show(){this.outputChannel.show()}clear(){this.outputChannel.clear(),this.info("Log cleared")}dispose(){this.outputChannel.dispose()}};d(fe,"Logger");var Z=fe;var $=class ${context;history=[];constructor(e){this.context=e,this.loadHistory()}loadHistory(){let e=this.context.globalState.get($.STORAGE_KEY,[]);this.history=e.map(t=>({...t,lastConnected:new Date(t.lastConnected)}))}async saveHistory(){await this.context.globalState.update($.STORAGE_KEY,this.history)}async addConnection(e,t,r){let n=`${e}:${t}`,s=this.history.findIndex(i=>i.id===n);if(s>=0){this.history[s].lastConnected=new Date,this.history[s].connectionCount++,r&&(this.history[s].name=r);let i=this.history.splice(s,1)[0];this.history.unshift(i)}else{let i={id:n,ip:e,port:t,name:r,lastConnected:new Date,connectionCount:1};this.history.unshift(i),this.history.length>$.MAX_HISTORY_ENTRIES&&(this.history=this.history.slice(0,$.MAX_HISTORY_ENTRIES))}await this.saveHistory()}async removeConnection(e){this.history=this.history.filter(t=>t.id!==e),await this.saveHistory()}async clearHistory(){this.history=[],await this.saveHistory()}getHistory(){return[...this.history]}getConnection(e){return this.history.find(t=>t.id===e)}async updateConnectionName(e,t){let r=this.history.find(n=>n.id===e);r&&(r.name=t,await this.saveHistory())}getRecentConnections(){return this.history.slice(0,5)}};d($,"ConnectionHistoryManager"),C($,"STORAGE_KEY","droidbridge.connectionHistory"),C($,"MAX_HISTORY_ENTRIES",10);var Q=$;var P=y(require("vscode"));var S=y(require("vscode"));var x=class x{currentTheme;themeChangeListeners=[];disposables=[];constructor(){this.currentTheme=this.detectCurrentTheme(),this.setupThemeChangeListener()}static getInstance(){return x.instance||(x.instance=new x),x.instance}detectCurrentTheme(){switch(S.window.activeColorTheme.kind){case S.ColorThemeKind.Light:return 1;case S.ColorThemeKind.Dark:return 2;case S.ColorThemeKind.HighContrast:return 3;case S.ColorThemeKind.HighContrastLight:return 4;default:return 2}}setupThemeChangeListener(){let e=S.window.onDidChangeActiveColorTheme(t=>{let r=this.mapColorThemeKindToThemeKind(t.kind);if(r!==this.currentTheme){let n=this.currentTheme;this.currentTheme=r,this.themeChangeListeners.forEach(s=>{try{s(r)}catch(i){console.error("Error in theme change listener:",i)}})}});this.disposables.push(e)}mapColorThemeKindToThemeKind(e){switch(e){case S.ColorThemeKind.Light:return 1;case S.ColorThemeKind.Dark:return 2;case S.ColorThemeKind.HighContrast:return 3;case S.ColorThemeKind.HighContrastLight:return 4;default:return 2}}getCurrentTheme(){return this.currentTheme}isDarkTheme(){return this.currentTheme===2||this.currentTheme===3}isLightTheme(){return this.currentTheme===1||this.currentTheme===4}getThemeSpecificIcon(e,t){let r=this.isDarkTheme()?"dark":"light";return S.Uri.joinPath(t,"media","icons",r,`${e}.svg`)}getWebviewIconUri(e,t,r){let n=this.getThemeSpecificIcon(e,t);return r.asWebviewUri(n)}getThemeCssClass(){switch(this.currentTheme){case 1:return"vscode-light";case 2:return"vscode-dark";case 3:return"vscode-high-contrast";case 4:return"vscode-high-contrast-light";default:return"vscode-dark"}}onThemeChanged(e){return this.themeChangeListeners.push(e),{dispose:d(()=>{let t=this.themeChangeListeners.indexOf(e);t>=0&&this.themeChangeListeners.splice(t,1)},"dispose")}}getThemeVariables(){return`
      :root {
        --theme-kind: '${this.getThemeCssClass()}';
        --is-dark-theme: ${this.isDarkTheme()?"true":"false"};
        --is-light-theme: ${this.isLightTheme()?"true":"false"};
      }
    `}refreshTheme(){let e=this.detectCurrentTheme();if(e!==this.currentTheme){let t=this.currentTheme;this.currentTheme=e,this.themeChangeListeners.forEach(r=>{try{r(e)}catch(n){console.error("Error in theme change listener during refresh:",n)}})}}dispose(){this.disposables.forEach(e=>e.dispose()),this.disposables=[],this.themeChangeListeners=[]}static resetInstance(){x.instance&&(x.instance.dispose(),x.instance=void 0)}};d(x,"ThemeManager"),C(x,"instance");var W=x;var te=class te{constructor(e,t,r){this._extensionUri=e;this._context=t;this.configManager=r,this.themeManager=W.getInstance(),this.connectionHistory=new Q(t),this.loadDefaultValues(),this.setupConfigurationWatcher(),this.setupThemeChangeListener()}_view;connectionStatus=!1;scrcpyStatus=!1;currentIp="";currentPort="";configManager;configChangeListener;themeManager;themeChangeListener;connectionHistory;loadDefaultValues(){let e=this.configManager.getConfigWithDefaults();this.currentIp=e.ip,this.currentPort=e.port}setupConfigurationWatcher(){this.configChangeListener=this.configManager.onConfigurationChanged(()=>{this.loadDefaultValues(),this._updateWebviewState()}),this._context.subscriptions.push(this.configChangeListener)}setupThemeChangeListener(){this.themeChangeListener=this.themeManager.onThemeChanged(e=>{this._view&&(this._view.webview.html=this._getHtmlForWebview(this._view.webview),this._view.webview.postMessage({type:"themeChanged",theme:e,isDark:this.themeManager.isDarkTheme(),isLight:this.themeManager.isLightTheme(),themeCssClass:this.themeManager.getThemeCssClass()}))}),this._context.subscriptions.push(this.themeChangeListener)}resolveWebviewView(e,t,r){console.log("DroidBridge: Resolving webview view"),this._view=e,e.webview.options={enableScripts:!0,localResourceRoots:[this._extensionUri]};try{e.webview.html=this._getHtmlForWebview(e.webview),console.log("DroidBridge: Webview HTML set successfully")}catch(n){console.error("DroidBridge: Error setting webview HTML:",n),e.webview.html=this._getSimpleHtmlForWebview(e.webview)}e.webview.onDidReceiveMessage(n=>{switch(n.type){case"connectDevice":P.commands.executeCommand("droidbridge.connectDevice",n.ip,n.port);break;case"disconnectDevice":P.commands.executeCommand("droidbridge.disconnectDevice");break;case"launchScrcpy":P.commands.executeCommand("droidbridge.launchScrcpy");break;case"launchScrcpyScreenOff":P.commands.executeCommand("droidbridge.launchScrcpyScreenOff");break;case"stopScrcpy":P.commands.executeCommand("droidbridge.stopScrcpy");break;case"showLogs":P.commands.executeCommand("droidbridge.showLogs");break;case"ipChanged":this.currentIp=n.value;break;case"portChanged":this.currentPort=n.value;break;case"connectFromHistory":P.commands.executeCommand("droidbridge.connectDevice",n.ip,n.port);break;case"removeFromHistory":this.connectionHistory.removeConnection(n.id),this._updateWebviewState();break;case"clearHistory":this.connectionHistory.clearHistory(),this._updateWebviewState();break}},void 0,this._context.subscriptions)}_getHtmlForWebview(e){let t=e.asWebviewUri(P.Uri.joinPath(this._extensionUri,"media","main.js")),r=e.asWebviewUri(P.Uri.joinPath(this._extensionUri,"media","reset.css")),n=e.asWebviewUri(P.Uri.joinPath(this._extensionUri,"media","vscode.css")),s=e.asWebviewUri(P.Uri.joinPath(this._extensionUri,"media","main.css")),i,a;try{i=this.themeManager.getWebviewIconUri("plug",this._extensionUri,e),a=this.themeManager.getWebviewIconUri("device-mobile",this._extensionUri,e)}catch(p){console.error("DroidBridge: Error getting theme icons:",p),i="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTggMkM2LjkgMiA2IDIuOSA2IDRWNkg0VjhIMTJWNkgxMFY0QzEwIDIuOSA5LjEgMiA4IDJaTTggNEM4LjYgNCA5IDQuNCA5IDVWNkg3VjVDNyA0LjQgNy40IDQgOCA0WiIgZmlsbD0iY3VycmVudENvbG9yIi8+Cjwvc3ZnPgo=",a="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQgMkMzLjQ0NzcyIDIgMyAyLjQ0NzcyIDMgM1YxM0MzIDEzLjU1MjMgMy40NDc3MiAxNCA0IDE0SDEyQzEyLjU1MjMgMTQgMTMgMTMuNTUyMyAxMyAxM1YzQzEzIDIuNDQ3NzIgMTIuNTUyMyAyIDEyIDJINFpNNSA0SDExVjEwSDVWNFoiIGZpbGw9ImN1cnJlbnRDb2xvciIvPgo8L3N2Zz4K"}let u,h;try{u=this.themeManager.getThemeCssClass(),h=this.themeManager.getThemeVariables()}catch(p){console.error("DroidBridge: Error getting theme info:",p),u="vscode-dark",h=""}let f=xe();return`<!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${e.cspSource} 'unsafe-inline'; script-src 'nonce-${f}'; img-src ${e.cspSource} data:;">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="${r}" rel="stylesheet">
        <link href="${n}" rel="stylesheet">
        <link href="${s}" rel="stylesheet">
        <style>
          ${h}
        </style>
        <title>DroidBridge</title>
      </head>
      <body class="${u}">
        <div class="container ${u}">
          <!-- Connect Section -->
          <div class="section">
            <div class="section-header">
              <img src="${i}" alt="Connect" width="16" height="16" class="section-icon" />
              <h3>Connect</h3>
            </div>
            <div class="section-content">
              <div class="status-indicator" id="connection-status">
                <span class="codicon codicon-x status-icon"></span>
                <span class="status-text">Disconnected</span>
              </div>
              
              <div class="input-group">
                <label for="ip-input">IP Address:</label>
                <input type="text" id="ip-input" placeholder="192.168.1.100" value="${this.currentIp}">
              </div>
              
              <div class="input-group">
                <label for="port-input">Port:</label>
                <input type="text" id="port-input" placeholder="5555" value="${this.currentPort}">
              </div>
              
              <div class="button-group">
                <button id="connect-btn" class="primary-button" ${!this.connectionStatus&&this.currentIp&&this.currentPort?"":"disabled"}>
                  <span class="codicon codicon-plug"></span>
                  Connect Device
                </button>
                <button id="disconnect-btn" class="secondary-button" ${this.connectionStatus?"":"disabled"}>
                  <span class="codicon codicon-debug-disconnect"></span>
                  Disconnect
                </button>
              </div>
            </div>
          </div>

          <!-- Scrcpy Section -->
          <div class="section">
            <div class="section-header">
              <img src="${a}" alt="Device" width="16" height="16" class="section-icon" />
              <h3>Scrcpy</h3>
            </div>
            <div class="section-content">
              <div class="status-indicator" id="scrcpy-status">
                <span class="codicon codicon-stop status-icon"></span>
                <span class="status-text">Stopped</span>
              </div>
              
              <div class="button-group">
                <button id="launch-scrcpy-btn" class="primary-button" ${!this.scrcpyStatus&&this.connectionStatus?"":"disabled"}>
                  <span class="codicon codicon-play"></span>
                  Launch Scrcpy
                </button>
                <button id="launch-scrcpy-screen-off-btn" class="secondary-button" ${!this.scrcpyStatus&&this.connectionStatus?"":"disabled"}>
                  <span class="codicon codicon-play-circle"></span>
                  Launch (Screen Off)
                </button>
                <button id="stop-scrcpy-btn" class="secondary-button" ${this.scrcpyStatus?"":"disabled"}>
                  <span class="codicon codicon-stop"></span>
                  Stop Scrcpy
                </button>
              </div>
            </div>
          </div>

          <!-- Connection History Section -->
          <div class="section">
            <div class="section-header">
              <span class="codicon codicon-history section-icon"></span>
              <h3>Recent Connections</h3>
            </div>
            <div class="section-content">
              <div id="connection-history">
                ${this.generateHistoryHtml()}
              </div>
            </div>
          </div>

          <!-- Logs Section -->
          <div class="section">
            <div class="section-content">
              <button id="show-logs-btn" class="secondary-button">
                <span class="codicon codicon-output"></span>
                Show Logs
              </button>
            </div>
          </div>
        </div>

        <script nonce="${f}" src="${t}"></script>
      </body>
      </html>`}refresh(){this._view&&(this._view.webview.html=this._getHtmlForWebview(this._view.webview))}_updateWebviewState(){this._view&&this._view.webview.postMessage({type:"updateState",connectionStatus:this.connectionStatus,scrcpyStatus:this.scrcpyStatus,currentIp:this.currentIp,currentPort:this.currentPort,connectionHistory:this.connectionHistory.getRecentConnections()})}_getSimpleHtmlForWebview(e){let t=xe();return`<!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${e.cspSource} 'unsafe-inline'; script-src 'nonce-${t}';">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DroidBridge</title>
        <style>
          body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            background-color: var(--vscode-sideBar-background);
            padding: 16px;
          }
          .section {
            margin-bottom: 20px;
          }
          .section h3 {
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
          }
          input {
            width: 100%;
            padding: 6px 8px;
            margin-bottom: 8px;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
          }
          button {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 2px;
            cursor: pointer;
          }
          button:hover {
            background-color: var(--vscode-button-hoverBackground);
          }
          button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
          }
          .status {
            padding: 8px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-size: 13px;
          }
          .status.connected {
            background-color: var(--vscode-charts-green, #4CAF50);
            color: white;
          }
          .status.disconnected {
            background-color: var(--vscode-charts-red, #F44336);
            color: white;
          }
        </style>
      </head>
      <body>
        <div class="section">
          <h3>\u{1F50C} Connect</h3>
          <div class="status disconnected" id="connection-status">Disconnected</div>
          <input type="text" id="ip-input" placeholder="IP Address (e.g., 192.168.1.100)" value="${this.currentIp}">
          <input type="text" id="port-input" placeholder="Port (e.g., 5555)" value="${this.currentPort}">
          <button id="connect-btn">Connect Device</button>
          <button id="disconnect-btn" disabled>Disconnect</button>
        </div>
        
        <div class="section">
          <h3>\u{1F4F1} Scrcpy</h3>
          <div class="status disconnected" id="scrcpy-status">Stopped</div>
          <button id="launch-scrcpy-btn" disabled>Launch Scrcpy</button>
          <button id="launch-scrcpy-screen-off-btn" disabled>Launch (Screen Off)</button>
          <button id="stop-scrcpy-btn" disabled>Stop Scrcpy</button>
        </div>
        
        <div class="section">
          <button id="show-logs-btn">Show Logs</button>
        </div>

        <script nonce="${t}">
          const vscode = acquireVsCodeApi();
          
          // Get elements
          const ipInput = document.getElementById('ip-input');
          const portInput = document.getElementById('port-input');
          const connectBtn = document.getElementById('connect-btn');
          const disconnectBtn = document.getElementById('disconnect-btn');
          const launchScrcpyBtn = document.getElementById('launch-scrcpy-btn');
          const launchScrcpyScreenOffBtn = document.getElementById('launch-scrcpy-screen-off-btn');
          const stopScrcpyBtn = document.getElementById('stop-scrcpy-btn');
          const showLogsBtn = document.getElementById('show-logs-btn');
          const connectionStatus = document.getElementById('connection-status');
          const scrcpyStatus = document.getElementById('scrcpy-status');
          
          // Event listeners
          connectBtn.addEventListener('click', () => {
            const ip = ipInput.value.trim();
            const port = portInput.value.trim();
            if (ip && port) {
              vscode.postMessage({ type: 'connectDevice', ip, port });
            }
          });
          
          disconnectBtn.addEventListener('click', () => {
            vscode.postMessage({ type: 'disconnectDevice' });
          });
          
          launchScrcpyBtn.addEventListener('click', () => {
            vscode.postMessage({ type: 'launchScrcpy' });
          });
          
          launchScrcpyScreenOffBtn.addEventListener('click', () => {
            vscode.postMessage({ type: 'launchScrcpyScreenOff' });
          });
          
          stopScrcpyBtn.addEventListener('click', () => {
            vscode.postMessage({ type: 'stopScrcpy' });
          });
          
          showLogsBtn.addEventListener('click', () => {
            vscode.postMessage({ type: 'showLogs' });
          });
          
          // Input change handlers
          ipInput.addEventListener('input', (e) => {
            vscode.postMessage({ type: 'ipChanged', value: e.target.value });
          });
          
          portInput.addEventListener('input', (e) => {
            vscode.postMessage({ type: 'portChanged', value: e.target.value });
          });
          
          // Listen for state updates
          window.addEventListener('message', event => {
            const message = event.data;
            if (message.type === 'updateState') {
              updateUI(message);
            }
          });
          
          function updateUI(state) {
            // Update connection status
            if (state.connectionStatus) {
              connectionStatus.textContent = 'Connected';
              connectionStatus.className = 'status connected';
              connectBtn.disabled = true;
              disconnectBtn.disabled = false;
            } else {
              connectionStatus.textContent = 'Disconnected';
              connectionStatus.className = 'status disconnected';
              connectBtn.disabled = false;
              disconnectBtn.disabled = true;
            }
            
            // Update scrcpy status
            if (state.scrcpyStatus) {
              scrcpyStatus.textContent = 'Running';
              scrcpyStatus.className = 'status connected';
              launchScrcpyBtn.disabled = true;
              launchScrcpyScreenOffBtn.disabled = true;
              stopScrcpyBtn.disabled = false;
            } else {
              scrcpyStatus.textContent = 'Stopped';
              scrcpyStatus.className = 'status disconnected';
              launchScrcpyBtn.disabled = !state.connectionStatus;
              launchScrcpyScreenOffBtn.disabled = !state.connectionStatus;
              stopScrcpyBtn.disabled = true;
            }
            
            // Update input values
            if (state.currentIp !== undefined) {
              ipInput.value = state.currentIp;
            }
            if (state.currentPort !== undefined) {
              portInput.value = state.currentPort;
            }
          }
        </script>
      </body>
      </html>`}generateHistoryHtml(){let e=this.connectionHistory.getRecentConnections();return e.length===0?'<div class="history-empty">No recent connections</div>':e.map(t=>{let r=t.name||`${t.ip}:${t.port}`,n=t.lastConnected.toLocaleDateString();return`
        <div class="history-item" data-id="${t.id}">
          <div class="history-info">
            <div class="history-name">${r}</div>
            <div class="history-details">${t.ip}:${t.port}</div>
            <div class="history-meta">Last: ${n} (${t.connectionCount}x)</div>
          </div>
          <div class="history-actions">
            <button class="history-connect-btn" data-ip="${t.ip}" data-port="${t.port}" title="Connect">
              <span class="codicon codicon-plug"></span>
            </button>
            <button class="history-remove-btn" data-id="${t.id}" title="Remove">
              <span class="codicon codicon-trash"></span>
            </button>
          </div>
        </div>
      `}).join("")}updateConnectionStatus(e,t,r){this.connectionStatus=e,t&&(this.currentIp=t),r&&(this.currentPort=r),e&&t&&r&&this.connectionHistory.addConnection(t,r),this._updateWebviewState()}updateScrcpyStatus(e){this.scrcpyStatus=e,this._updateWebviewState()}updateIpAddress(e){this.currentIp=e,this._updateWebviewState()}updatePort(e){this.currentPort=e,this._updateWebviewState()}getConnectionStatus(){return this.connectionStatus}getScrcpyStatus(){return this.scrcpyStatus}getCurrentIp(){return this.currentIp}getCurrentPort(){return this.currentPort}reset(){this.connectionStatus=!1,this.scrcpyStatus=!1,this.loadDefaultValues(),this._updateWebviewState()}synchronizeState(e,t){let r=!1;this.connectionStatus!==e.connected&&(this.connectionStatus=e.connected,r=!0),e.connected&&e.deviceIp&&e.devicePort&&(this.currentIp!==e.deviceIp||this.currentPort!==e.devicePort)&&(this.currentIp=e.deviceIp,this.currentPort=e.devicePort,r=!0),this.scrcpyStatus!==t.running&&(this.scrcpyStatus=t.running,r=!0),r&&this._updateWebviewState()}forceRefresh(){this.loadDefaultValues(),this.refresh()}getCurrentState(){return{connectionStatus:this.connectionStatus,scrcpyStatus:this.scrcpyStatus,currentIp:this.currentIp,currentPort:this.currentPort}}dispose(){this.configChangeListener&&this.configChangeListener.dispose(),this.themeChangeListener&&this.themeChangeListener.dispose()}};d(te,"DroidBridgeSidebarProvider"),C(te,"viewType","droidbridge.sidebar");var J=te;function xe(){let o="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<32;t++)o+=e.charAt(Math.floor(Math.random()*e.length));return o}d(xe,"getNonce");var b,l,z,X,V,L,R,re;function Ve(o){l=new Z,l.info("DroidBridge extension is activating...");try{ze(o),Ke(),Ge(o),je(o),Me(),b.initialized=!0,l.info("DroidBridge extension activated successfully")}catch(e){throw l.error("Failed to activate DroidBridge extension",e),U.window.showErrorMessage("Failed to activate DroidBridge extension. Check the logs for details."),e}}d(Ve,"activate");function ze(o){l.info("Initializing manager classes..."),V=new j,l.debug("ConfigManager initialized"),re=W.getInstance(),l.debug("ThemeManager initialized"),L=new _(o.extensionPath,V),l.debug("BinaryManager initialized"),X=new G(L,l),l.debug("ProcessManager initialized"),R=new J(U.Uri.file(o.extensionPath),o,V),l.debug("DroidBridgeSidebarProvider initialized"),z=new K(X,V,l,L,R),l.debug("CommandManager initialized"),z.setSidebarProvider(R),l.debug("Manager cross-references established")}d(ze,"initializeManagers");function Ke(){b={connection:{connected:!1},scrcpy:{running:!1},initialized:!1,binariesValidated:!1},l.debug("Extension state initialized")}d(Ke,"initializeExtensionState");function Ge(o){l.info("Registering VSCode components...");let e=U.window.registerWebviewViewProvider("droidbridge-sidebar",R);o.subscriptions.push(e),l.debug("Sidebar webview provider registered"),z.registerCommands(o),l.debug("All commands registered"),l.info("All VSCode components registered successfully")}d(Ge,"registerVSCodeComponents");function je(o){l.info("Setting up configuration watchers...");let e=V.onConfigurationChanged(()=>{l.info("Configuration changed, refreshing extension state"),R.refresh(),Me()});o.subscriptions.push(e),l.debug("Configuration watchers set up")}d(je,"setupConfigurationWatchers");function Me(){L.setDownloadProgressCallback(o=>{l.info(`Downloading ${o.binary}: ${o.percentage}% (${o.downloaded}/${o.total} bytes)`)}),L.validateBinaries().then(o=>{b.binariesValidated=o.adbValid&&o.scrcpyValid,b.binariesValidated?(l.info("All binaries validated successfully"),L.getBinaryInfo().then(e=>{l.info(`ADB: ${e.adb.path} (${e.adb.source}${e.adb.version?`, v${e.adb.version}`:""})`),l.info(`Scrcpy: ${e.scrcpy.path} (${e.scrcpy.source}${e.scrcpy.version?`, v${e.scrcpy.version}`:""})`)})):(l.error("Binary validation failed",new Error(o.errors.join(", "))),L.needsDownload().then(e=>{e.needed?U.window.showWarningMessage(`DroidBridge needs to download missing binaries: ${e.binaries.join(", ")}. This will happen automatically when needed.`,"Show Logs").then(t=>{t==="Show Logs"&&l.show()}):U.window.showWarningMessage("Some DroidBridge binaries are not available. Check the logs for details.","Show Logs").then(t=>{t==="Show Logs"&&l.show()})}))}).catch(o=>{l.error("Failed to validate binaries",o),b.binariesValidated=!1})}d(Me,"validateBinariesAsync");async function Ye(){l&&l.info("DroidBridge extension is deactivating...");let o=[];try{z&&(l.debug("Disposing command manager..."),z.dispose()),R&&(l.debug("Disposing sidebar provider..."),R.dispose()),X&&(l.debug("Cleaning up process manager..."),o.push(X.cleanup())),await Promise.all(o),re&&(l.debug("Disposing theme manager..."),re.dispose()),b&&(b.initialized=!1,b.binariesValidated=!1,b.connection.connected=!1,b.scrcpy.running=!1),l&&(l.info("DroidBridge extension deactivated successfully"),l.dispose())}catch(e){let t=e instanceof Error?e.message:"Unknown error";if(console.error("Error during extension deactivation:",t),l)try{l.error("Error during extension deactivation",e instanceof Error?e:void 0)}catch(r){console.error("Failed to log deactivation error:",r)}}finally{b=void 0,l=void 0,z=void 0,X=void 0,V=void 0,L=void 0,R=void 0,re=void 0}}d(Ye,"deactivate");function qe(){return b}d(qe,"getExtensionState");function _e(){return l}d(_e,"getLogger");function Ze(){return(b==null?void 0:b.initialized)===!0}d(Ze,"isExtensionInitialized");0&&(module.exports={activate,deactivate,getExtensionState,getLogger,isExtensionInitialized});
